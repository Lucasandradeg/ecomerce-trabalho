<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Detalhes do Produto</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="css/style.css" />
</head>
<body>
<main class="container" id="content">
    <a href="index.html" class="btn btn-outline back-link">← Voltar ao catálogo</a>

    <div id="cart-status" aria-live="polite"></div>

    <section id="produto-section" class="product-grid" aria-busy="true" aria-live="polite">

    </section>
</main>


<script src="js/carrinho.js"></script>

<script>
    (function(){
        const BRL = (n)=> 'R$ ' + Number(n||0).toFixed(2);

        function getParam(name){
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        async function loadProdutosFromCatalogo(){
            const res = await fetch('js/catalogo.js', {cache:'no-store'});
            const text = await res.text();

            const start = text.indexOf('const produtos =');
            if(start === -1) throw new Error('Não encontrei definição de "const produtos =" em catalogo.js');

            const after = text.slice(start);
            const openIdx = after.indexOf('[');
            if(openIdx === -1) throw new Error('Não encontrei "[" do array de produtos');

            let i = openIdx + 1, depth = 1;
            while (i < after.length && depth > 0){
                const ch = after[i];
                if(ch === '[') depth++;
                else if(ch === ']') depth--;
                i++;
            }
            if(depth !== 0) throw new Error('Falha ao balancear colchetes do array de produtos');

            const arrayLiteral = after.slice(openIdx, i);
            const produtos = Function('"use strict";return (' + arrayLiteral + ')')();
            if(!Array.isArray(produtos)) throw new Error('Produtos extraídos não são um array');
            return produtos;
        }

        function notFound(msg){
            document.getElementById('produto-section').innerHTML = `
          <div>
            <h1 tabindex="-1">${msg}</h1>
            <p><a href="index.html" class="btn btn-outline">Voltar ao catálogo</a></p>
          </div>`;
            const h1 = document.querySelector('#produto-section h1'); h1 && h1.focus();
        }

        function render(prod){
            const sec = document.getElementById('produto-section');
            sec.setAttribute('aria-busy','false');
            sec.innerHTML = `
          <div>
            <img class="img" src="${prod.imagem || ''}" alt="${prod.nome || 'Produto'}">
          </div>
          <div>
            <h1 id="produto-titulo" tabindex="-1" class="produto-titulo">${prod.nome || 'Produto'}</h1>
            <p class="produto-preco">${BRL(prod.preco)}</p>
            <p class="produto-desc">${prod.descricao || 'Sem descrição.'}</p>

            <div class="qty-wrap">
              <label for="qty">Quantidade:</label>
              <button type="button" id="qty-dec" aria-label="Diminuir quantidade">−</button>
              <input id="qty" type="number" min="1" value="1" aria-label="Quantidade">
              <button type="button" id="qty-inc" aria-label="Aumentar quantidade">+</button>
            </div>

            <div class="actions-line">
              <button id="btn-add" class="btn btn-primary">Adicionar ao carrinho</button>
              <a href="checkout.html" class="btn btn-outline">Ir para o checkout</a>
            </div>
          </div>
        `;

            document.getElementById('produto-titulo')?.focus();

            const qty = document.getElementById('qty');
            document.getElementById('qty-inc').addEventListener('click', ()=> qty.value = String(Math.max(1, Number(qty.value||1)+1)));
            document.getElementById('qty-dec').addEventListener('click', ()=> qty.value = String(Math.max(1, Number(qty.value||1)-1)));

            document.getElementById('btn-add').addEventListener('click', ()=>{
                const quantidade = Math.max(1, Number(qty.value||1));
                window.Cart.add({
                    id: prod.id,
                    nome: prod.nome,
                    preco: Number(prod.preco||0),
                    imagem: prod.imagem || '',
                    quantidade
                });
                const live = document.getElementById('cart-status');
                if(live) live.textContent = 'Produto adicionado ao carrinho.';
            });
        }

        (async function boot(){
            try{
                const id = getParam('id');
                if(!id) return notFound('Produto não informado.');
                const lista = await loadProdutosFromCatalogo();
                const prod = lista.find(p => String(p.id) === String(id));
                if(!prod) return notFound('Produto não encontrado.');
                render(prod);
            }catch(err){
                console.error(err);
                notFound('Falha ao carregar produto.');
            }
        })();
    })();
</script>
</body>
</html>